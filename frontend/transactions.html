<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Dépenses - Historique des Opérations | Précision Financière</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/icons.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/logo-colors.css">
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/empty-states.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <meta name="description"
        content="Consultez et gérez vos flux de trésorerie avec une précision chirurgicale. L'historique complet de vos succès financiers avec Suivi Dépenses.">
    <meta property="og:title" content="Suivi Dépenses - Maîtrise des Flux">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar Adaptée -->
        <aside class="sidebar" aria-label="Navigation principale">
            <div class="sidebar-logo">
                <img src="img/logo (1).jpg" alt="Suivi Dépenses" class="brand-logo-img" width="38" height="38"
                    loading="eager">
                <div class="sidebar-logo-text">Suivi Dépenses</div>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="sidebar-nav-link"><i class="fas fa-home"
                        aria-hidden="true"></i><span>Tableau de Bord</span></a>
                <a href="transactions.html" class="sidebar-nav-link active"><i class="fas fa-exchange-alt"
                        aria-hidden="true"></i><span>Transactions</span></a>
                <a href="statistics.html" class="sidebar-nav-link"><i class="fas fa-chart-pie"
                        aria-hidden="true"></i><span>Statistiques</span></a>
                <a href="categories.html" class="sidebar-nav-link"><i class="fas fa-th-large"
                        aria-hidden="true"></i><span>Catégories</span></a>
                <a href="settings.html" class="sidebar-nav-link"><i class="fas fa-cog"
                        aria-hidden="true"></i><span>Paramètres</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-footer-block">
                    <div class="sidebar-footer-block-title"><i class="fas fa-shield-alt"
                            style="color: var(--color-emerald);" aria-hidden="true"></i><span>Sécurité Active</span>
                    </div>
                    <p>Chiffrement AES-256 bits et audit de sécurité conforme RGPD.</p>
                </div>
                <button type="button" onclick="logout()" class="sidebar-btn-logout" aria-label="Se déconnecter"><i
                        class="fas fa-sign-out-alt" aria-hidden="true"></i><span>Déconnexion</span></button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header Premium Concept -->
            <header class="page-header">
                <div class="page-title-box">
                    <div class="page-title-icon"><i class="fas fa-exchange-alt" aria-hidden="true"></i></div>
                    <h1 class="page-title">Mes Opérations</h1>
                </div>
                <div class="header-icons">
                    <div class="header-actions">
                        <button type="button" class="header-icon" aria-label="Notifications"><i
                                class="far fa-bell"></i></button>
                        <button type="button" class="header-icon" aria-label="Rechercher"><i
                                class="far fa-search"></i></button>
                    </div>
                    <div class="user-profile">
                        <img src="https://ui-avatars.com/api/?background=06B6D4&color=fff&name=U"
                            class="user-avatar-img" id="userAvatarImg" width="32" height="32" alt="">
                    </div>
                </div>
            </header>

            <div class="content-padding">
                <div id="demoBannerContainer"></div>
                <!-- Transaction Stats -->
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-card-premium">
                        <div class="stat-icon-circle income-icon">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="stat-label">Total des Revenus</div>
                        <div class="stat-value-large" id="totalIncomeValue" style="color: var(--income-green);">0 GNF
                        </div>
                    </div>
                    <div class="stat-card-premium">
                        <div class="stat-icon-circle expense-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="stat-label">Total des Dépenses</div>
                        <div class="stat-value-large" id="totalExpenseValue" style="color: var(--expense-red);">0 GNF
                        </div>
                    </div>
                </div>

                <!-- Filters & Controls -->
                <div class="card" style="padding: 1.5rem 2.5rem; margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; gap: 1rem; flex: 1; flex-wrap: wrap; align-items: center;">
                            <div style="position: relative; flex: 1; max-width: 400px;">
                                <i class="fas fa-search"
                                    style="position: absolute; left: 1.25rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                                <input type="text" id="searchInput" class="form-input"
                                    placeholder="Rechercher une transaction..."
                                    style="padding-left: 3rem; border-radius: 12px;">
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                                <select id="categoryFilter" class="form-input"
                                    style="width: 180px; border-radius: 12px; cursor: pointer;">
                                    <option value="">Toutes Catégories</option>
                                </select>
                                <select id="typeFilter" class="form-input"
                                    style="width: 140px; border-radius: 12px; cursor: pointer;">
                                    <option value="">Tous Types</option>
                                    <option value="expense">Dépenses</option>
                                    <option value="revenue">Revenus</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-premium" onclick="openModal()"
                            style="padding: 1rem 2rem; border-radius: 14px; box-shadow: var(--shadow-glow);">
                            <i class="fas fa-plus-circle" style="font-size: 1.1rem;"></i>
                            Nouvelle Transaction
                        </button>
                    </div>
                </div>

                <!-- Transaction List -->
                <div class="card" style="padding: 0; overflow: hidden;" role="region"
                    aria-label="Liste des transactions">
                    <div class="card-header" style="padding: 2.5rem 2.5rem 1.5rem 2.5rem;">
                        <div>
                            <h2 class="card-title">Historique Complet</h2>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">Gérez vos
                                opérations passées et futures</p>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table-premium">
                            <thead>
                                <tr>
                                    <th style="padding-left: 2.5rem;">DATE</th>
                                    <th>DESCRIPTION</th>
                                    <th>CATÉGORIE</th>
                                    <th>TYPE</th>
                                    <th style="text-align: right;">MONTANT</th>
                                    <th style="padding-right: 2.5rem; text-align: right;">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <!-- Loaded via JS -->
                            </tbody>
                        </table>
                    </div>

                    <div id="pagination"
                        style="display: flex; justify-content: center; gap: 0.75rem; padding: 2.5rem; border-top: 1px solid var(--border-soft);">
                        <!-- JS pagination -->
                    </div>
                </div>
            </div>
    </div>
    </main>
    </div>

    <!-- Modal Form (Hidden) -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="card-title" style="margin-bottom: 2rem;">Nouvelle Transaction</h2>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group">
                    <label class="form-label">Type de Transaction</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <label
                            style="cursor: pointer; padding: 1rem; border: 1px solid var(--border-gray); border-radius: 10px; display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="type" value="expense" checked> Dépense
                        </label>
                        <label
                            style="cursor: pointer; padding: 1rem; border: 1px solid var(--border-gray); border-radius: 10px; display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="type" value="revenue"> Revenu
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" id="amountLabel">Montant (GNF)</label>
                    <input type="number" id="amount" step="1" class="form-input" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Catégorie</label>
                    <select id="selectedCategoryId" class="form-input" required>
                        <!-- Loaded by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="description" class="form-input" placeholder="Ex: Courses week-end">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2.5rem;">
                    <button type="button" class="btn-premium"
                        style="background: var(--bg-light); color: var(--text-dark);"
                        onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn-premium"
                        style="flex: 1; justify-content: center;">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* CSS pour le modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            position: relative;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2.5rem;
            animation: slideInUp 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Fermer le modal en cliquant en dehors */
        .modal-content {
            pointer-events: all;
        }
    </style>

    <script src="js/icons.js"></script>
    <script src="js/currency.js"></script>
    <script src="js/api.js"></script>
    <script src="js/demo-data.js"></script>
    <script src="js/api-demo.js"></script>
    <script src="js/init-demo.js"></script>
    <script src="js/empty-state.js"></script>
    <script>
        checkAuth();

        // Fonctions pour gérer le modal
        function openModal() {
            const modal = document.getElementById('transactionModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('transactionForm');

            // Réinitialiser le formulaire
            form.reset();
            document.getElementById('transactionId').value = '';
            modalTitle.textContent = 'Nouvelle Transaction';

            // Définir la date par défaut à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            // Mettre à jour le label du montant
            const amountLabel = document.getElementById('amountLabel');
            const amountInput = document.getElementById('amount');
            if (amountLabel) amountLabel.textContent = `Montant (${CURRENCY_CONFIG.symbol})`;
            if (amountInput) amountInput.placeholder = getCurrencyInputPlaceholder();

            // Afficher le modal
            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('transactionModal');
            modal.classList.remove('show');
        }

        function editTransaction(id) {
            const req = request();
            req(`/api/transactions/${id}`).then(transaction => {
                const modal = document.getElementById('transactionModal');
                const modalTitle = document.getElementById('modalTitle');

                // Remplir le formulaire avec les données existantes
                document.getElementById('transactionId').value = transaction.id;
                document.getElementById('amount').value = transaction.amount;
                document.getElementById('date').value = transaction.date;
                document.getElementById('selectedCategoryId').value = transaction.category_id;
                document.getElementById('description').value = transaction.description || '';

                // Sélectionner le bon type
                const typeRadio = document.querySelector(`input[name="type"][value="${transaction.type}"]`);
                if (typeRadio) typeRadio.checked = true;

                modalTitle.textContent = 'Modifier la Transaction';
                modal.classList.add('show');
            }).catch(err => {
                if (window.showToast) showToast('Erreur lors du chargement de la transaction', 'error');
                else alert('Erreur lors du chargement de la transaction');
            });
        }

        // Fermer le modal en cliquant en dehors
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('transactionModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }
        });

        // Fermer le modal avec la touche Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        let categories = [];
        let currentPage = 1;
        const request = () => (window.apiRequestWithDemo || apiRequest).bind(window);

        async function init() {
            try {
                categories = await request()('/api/categories') || [];
                const catFilter = document.getElementById('categoryFilter');
                const catSelect = document.getElementById('selectedCategoryId');
                if (catFilter) {
                    const currentFilter = catFilter.value;
                    catFilter.innerHTML = '<option value="">Toutes les catégories</option>';
                    categories.forEach(cat => {
                        catFilter.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                    if (currentFilter) catFilter.value = currentFilter;
                }
                if (catSelect) {
                    const currentSelect = catSelect.value;
                    catSelect.innerHTML = '<option value="">Sélectionner...</option>';
                    categories.forEach(cat => {
                        catSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                    if (currentSelect) catSelect.value = currentSelect;
                }

                const stats = await request()('/api/transactions/stats/summary');
                const incomeEl = document.getElementById('totalIncomeValue');
                const expenseEl = document.getElementById('totalExpenseValue');
                if (incomeEl) incomeEl.textContent = formatCurrency(stats && stats.total_income != null ? stats.total_income : 0);
                if (expenseEl) expenseEl.textContent = formatCurrency(stats && stats.total_expense != null ? stats.total_expense : 0);

                loadTransactions();

                const user = getCurrentUser();
                if (user) {
                    const av = document.getElementById('userAvatarImg');
                    if (av) av.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=2563EB&color=fff`;
                }
                if (window.renderDemoBanner) renderDemoBanner('demoBannerContainer');
            } catch (err) { console.error(err); if (window.renderDemoBanner) renderDemoBanner('demoBannerContainer'); }
        }

        async function loadTransactions(page = 1) {
            currentPage = page;
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const typeFilter = document.getElementById('typeFilter');
            const searchTerm = searchInput ? searchInput.value : '';
            const categoryId = categoryFilter ? categoryFilter.value : '';
            const type = typeFilter ? typeFilter.value : '';

            let url = `/api/transactions?page=${page}&per_page=10`;
            if (searchTerm) url += `&search=${searchTerm}`;
            if (categoryId) url += `&category_id=${categoryId}`;
            if (type) url += `&type=${type}`;

            try {
                const data = await request()(url);
                const list = (data && data.data) ? data.data : [];
                renderTransactions(list);
                renderPagination((data && data.pages) ? data.pages : 0, (data && data.current_page) ? data.current_page : 1);
            } catch (err) {
                console.error(err);
                // En cas d'erreur, essayer les données de démo
                try {
                    if (window.DEMO_DATA) {
                        const demoRes = await window.DEMO_DATA.getDemoTransactions(page, searchTerm, categoryId, type);
                        renderTransactions(demoRes.data || []);
                        renderPagination(demoRes.pages || 1, demoRes.current_page || page);
                    } else {
                        renderTransactions([]);
                    }
                } catch (e) {
                    console.error('Error loading demo transactions:', e);
                    renderTransactions([]);
                }
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsTable');
            if (!tbody) return;
            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-table-cell">
                    <div class="empty-state">
                        <div class="empty-state-illus"><div class="empty-state-img" style="width:100px;height:100px;margin:0 auto 1rem;border-radius:50%;background:linear-gradient(135deg,rgba(6,182,212,0.12),rgba(16,185,129,0.08));display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:var(--color-cyan);"><i class="fas fa-exchange-alt" aria-hidden="true"></i></div></div>
                        <h3 class="empty-state-title">Aucune opération</h3>
                        <p class="empty-state-text">Enregistrez vos premières transactions pour les voir apparaître ici.</p>
                        <div class="empty-state-actions"><button type="button" class="btn-premium" onclick="openModal()">Ajouter une transaction</button></div>
                    </div></td></tr>`;
                return;
            }

            tbody.innerHTML = transactions.map((t, index) => {
                const isIncome = (t.type === 'revenue' || t.type === 'revenu');
                return `
                <tr style="transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); opacity: 0; animation: fadeInUp 0.5s ease forwards; animation-delay: ${index * 60}ms;">
                    <td style="padding-left: 2rem;">
                        <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-dark);">${new Date(t.date).toLocaleDateString('fr-FR')}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">#${t.id.toString().padStart(6, '0')}</div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 36px; height: 36px; border-radius: 10px; background: ${isIncome ? 'rgba(16, 185, 129, 0.1)' : 'rgba(248, 250, 252, 1)'}; color: ${isIncome ? '#10B981' : '#64748B'}; display: flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
                                <i class="fas ${isIncome ? 'fa-arrow-down' : 'fa-shopping-cart'}"></i>
                            </div>
                            <div style="font-weight: 700; color: var(--text-dark);">${t.description || 'Sans titre'}</div>
                        </div>
                    </td>
                    <td>
                        <div style="display: inline-flex; align-items: center; gap: 0.6rem; background: #F8FAFC; padding: 0.4rem 0.8rem; border-radius: 8px; border: 1px solid var(--border-soft); transition: transform 0.2s;">
                            <span style="width: 8px; height: 8px; border-radius: 2px; background: ${t.category_color}; box-shadow: 0 0 6px ${t.category_color}44;"></span>
                            <span style="font-weight: 600; font-size: 0.8rem; color: var(--text-main);">${t.category_name}</span>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${isIncome ? 'badge-income' : 'badge-expense'}" style="padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: inline-flex; align-items: center; gap: 6px;">
                            <i class="fas ${isIncome ? 'fa-check' : 'fa-minus'}" style="font-size: 0.7rem;"></i> ${isIncome ? 'CRÉDIT' : 'DÉBIT'}
                        </span>
                    </td>
                    <td style="text-align: right; font-weight: 800; font-size: 1.1rem; ${isIncome ? 'color: var(--income-green);' : 'color: var(--text-dark);'}">
                        ${isIncome ? '+' : ''}${formatCurrency(t.amount, false)} GNF
                    </td>
                    <td style="padding-right: 2rem; text-align: right;">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end; opacity: 0.7; transition: opacity 0.2s;" onmouseenter="this.style.opacity='1'" onmouseleave="this.style.opacity='0.7'">
                            <button onclick="editTransaction(${t.id})" class="action-btn edit-btn" title="Modifier" style="width: 34px; height: 34px; border-radius: 8px; border: 1px solid var(--border-soft); background: white; color: var(--primary-blue); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-pen" style="font-size: 0.85rem;"></i>
                            </button>
                            <button onclick="deleteTransaction(${t.id})" class="action-btn delete-btn" title="Supprimer" style="width: 34px; height: 34px; border-radius: 8px; border: 1px solid var(--border-soft); background: white; color: var(--expense-red); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-trash" style="font-size: 0.85rem;"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function renderPagination(total, current) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            for (let i = 1; i <= total; i++) {
                container.innerHTML += `<button onclick="loadTransactions(${i})" class="btn-premium" style="padding: 0.5rem 1rem; ${i === current ? 'background: var(--sidebar-deep);' : 'background: white; color: var(--text-dark); border: 1px solid var(--border-gray);'}">${i}</button>`;
            }
        }

        function openModal() {
            document.getElementById('transactionModal').style.display = 'flex';
            document.getElementById('modalTitle').textContent = 'Nouvelle Transaction';
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('date').valueAsDate = new Date();
        }

        function closeModal() { document.getElementById('transactionModal').style.display = 'none'; }

        async function editTransaction(id) {
            const req = request();
            const t = await req(`/api/transactions/${id}`);
            openModal();
            document.getElementById('modalTitle').textContent = 'Modifier Transaction';
            document.getElementById('transactionId').value = t.id;
            document.getElementById('amount').value = t.amount;
            document.getElementById('date').value = t.date;
            document.getElementById('description').value = t.description;
            document.getElementById('selectedCategoryId').value = t.category_id;
            const typeValue = t.type === 'revenu' ? 'revenue' : 'expense';
            const typeRadio = document.querySelector(`input[name="type"][value="${typeValue}"]`);
            if (typeRadio) typeRadio.checked = true;
        }

        async function deleteTransaction(id) {
            if (confirm('Supprimer cette transaction ?')) {
                const req = request();
                await req(`/api/transactions/${id}`, 'DELETE');
                loadTransactions(currentPage);
                // Recharger aussi les stats si on est sur dashboard
                if (window.location.pathname.includes('dashboard')) {
                    setTimeout(() => window.location.reload(), 500);
                }
            }
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const req = request();
            const id = document.getElementById('transactionId').value;
            const data = {
                type: document.querySelector('input[name="type"]:checked').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('date').value,
                category_id: parseInt(document.getElementById('selectedCategoryId').value),
                description: document.getElementById('description').value
            };

            try {
                if (id) await req(`/api/transactions/${id}`, 'PUT', data);
                else await req('/api/transactions', 'POST', data);
                closeModal();
                loadTransactions(currentPage);
                // Recharger les stats sur cette page
                const stats = await req('/api/transactions/stats/summary');
                const incomeEl = document.getElementById('totalIncomeValue');
                const expenseEl = document.getElementById('totalExpenseValue');
                if (incomeEl) incomeEl.textContent = formatCurrency(stats && stats.total_income != null ? stats.total_income : 0);
                if (expenseEl) expenseEl.textContent = formatCurrency(stats && stats.total_expense != null ? stats.total_expense : 0);
                if (window.showToast) showToast('Transaction enregistrée avec succès !', 'success');

                // Si le dashboard est ouvert dans un autre onglet, le recharger
                if (window.opener && !window.opener.closed) {
                    try {
                        window.opener.location.reload();
                    } catch (e) { }
                }
            } catch (err) {
                if (window.showToast) showToast(err.message || 'Erreur lors de l\'enregistrement', 'error');
                else alert(err.message);
            }
        });

        document.getElementById('searchInput').addEventListener('input', () => loadTransactions(1));
        const catFilter = document.getElementById('categoryFilter');
        const typeFilter = document.getElementById('typeFilter');
        if (catFilter) catFilter.addEventListener('change', () => loadTransactions(1));
        if (typeFilter) typeFilter.addEventListener('change', () => loadTransactions(1));

        // Rendre init accessible globalement pour rechargement depuis autres pages
        window.reloadTransactionCategories = init;

        init();

        // Recharger quand les données sont mises à jour (depuis autres pages)
        window.addEventListener('suivi-data-updated', () => {
            setTimeout(() => {
                loadTransactions(currentPage);
                const req = request();
                req('/api/transactions/stats/summary').then(stats => {
                    const incomeEl = document.getElementById('totalIncomeValue');
                    const expenseEl = document.getElementById('totalExpenseValue');
                    if (incomeEl) incomeEl.textContent = formatCurrency(stats && stats.total_income != null ? stats.total_income : 0);
                    if (expenseEl) expenseEl.textContent = formatCurrency(stats && stats.total_expense != null ? stats.total_expense : 0);
                });
            }, 500);
        });
    </script>
</body>

</html>